name: Autocorrección (standalone)

on:
  repository_dispatch:
    types: [autocorreccion]
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  evaluar:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout alumno (main)
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 1

      - name: Checkout rubricas
        uses: actions/checkout@v4
        with:
          repository: 4GAES/rubricas
          path: rubricas
          ref: main
          fetch-depth: 1

      - name: Configurar entorno Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Instalar dependencias requeridas
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml requests python-dotenv rich

      - name: Run evaluator (GPT-5 nano)
        env:
          KLAUS: ${{ secrets.KLAUS }}
          # payload: pasa la cadena desde tu backend o edítalo aquí:
          CLIENT_PAYLOAD_JSON: >-
            {
              "slug": "instagram-feed-bootstrap",
              "rubrics_ref": "main",
              "rubrics_chain": [
                "modules/intro_web@1.0.0.yaml",
                "stacks/frontend-js@1.0.0.yaml",
                "globals/base@1.yaml"
              ],
              "scoring": {
                "type":"A",
                "ensemble_size":1,
                "max_context_bytes":250000,
                "model":"gpt-5-nano"
              },
              "problem_path": "",
              "solution_path": ""
            }
        run: |
          python .github/tools/auto_evaluator.py

      - name: Crear/actualizar Issue (por SHA)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          SHA_SHORT=$(git rev-parse --short HEAD)
          TITLE="[AutoCorrección] instagram-feed-bootstrap - main@${SHA_SHORT}"
          LABELS="autocorreccion,slug:instagram-feed-bootstrap,branch:main,sha:${SHA_SHORT}"
          existing=$(gh issue list --limit 100 --search "$TITLE in:title" --json number --jq '.[0].number' || true)
          if [ -n "$existing" ]; then
            gh issue edit "$existing" --add-label "$LABELS" --body-file ISSUE_BODY.md
          else
            # cerrar issues previos del mismo slug en main
            old=$(gh issue list --limit 100 --search "[AutoCorrección] instagram-feed-bootstrap - main@ in:title" --json number,title --jq '.[] | select(.title != "'"$TITLE"'") | .number')
            for n in $old; do gh issue close "$n" --comment "Nueva entrega detectada (main@${SHA_SHORT})."; done
            gh issue create --title "$TITLE" --label "$LABELS" --body-file ISSUE_BODY.md
          fi

      - name: Subir artefactos
        uses: actions/upload-artifact@v4
        with:
          name: reporte
          path: |
            results.csv
            evaluation.log
            scanner_meta.json
            rubrica_efectiva.yaml
            ISSUE_BODY.md
